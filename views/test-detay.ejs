<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= testDurum.gorunen_test_adi %> - Sanal Optik Form</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .btn-back {
      background: rgba(255,255,255,0.2);
      color: white;
      border: 2px solid white;
      padding: 8px 20px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    .btn-back:hover {
      background: white;
      color: #667eea;
    }
    
    .container {
      max-width: 900px;
      margin: 30px auto;
      padding: 0 20px;
    }
    
    .test-header {
      background: white;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    }
    
    .test-header h2 {
      font-size: 28px;
      color: #333;
      margin-bottom: 10px;
    }
    
    .test-header p {
      color: #666;
      font-size: 14px;
    }
    
    .question-card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    }
    
    .question-number {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      display: inline-block;
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: 600;
      margin-bottom: 15px;
      font-size: 14px;
    }

    .question-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      gap: 15px;
    }

    .question-title-wrapper {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
    }

    .question-title {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 10px 16px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      display: inline-block;
      white-space: nowrap;
    }

    .student-answer-chip {
      display: inline-flex;
      align-items: center;
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
      gap: 6px;
      box-shadow: 0 2px 6px rgba(40, 167, 69, 0.3);
    }

    .answer-label {
      opacity: 0.9;
      font-size: 11px;
    }

    .answer-value {
      background: rgba(255, 255, 255, 0.2);
      padding: 2px 8px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 13px;
    }

    .question-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .video-stats {
      display: flex;
      align-items: center;
      gap: 6px;
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      cursor: help;
      transition: all 0.3s ease;
      box-shadow: 0 2px 6px rgba(255, 107, 107, 0.3);
    }

    .video-stats:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4);
    }

    .video-icon {
      font-size: 14px;
    }

    .video-count {
      background: rgba(255, 255, 255, 0.2);
      padding: 2px 6px;
      border-radius: 10px;
      font-weight: 700;
      min-width: 20px;
      text-align: center;
    }
    
    .question-text {
      color: #333;
      font-size: 16px;
      margin-bottom: 20px;
      line-height: 1.6;
    }
    
    .options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 15px;
    }
    
    .option {
      position: relative;
    }
    
    .option input[type="radio"] {
      position: absolute;
      opacity: 0;
    }
    
    .option label {
      display: block;
      padding: 15px;
      background: #f8f8f8;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      text-align: center;
      font-weight: 600;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.3s;
      color: #333;
    }
    
    .option input[type="radio"]:checked + label {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-color: #667eea;
      color: white;
      transform: scale(1.05);
    }
    
    .option label:hover {
      border-color: #667eea;
      transform: scale(1.02);
    }
    
    .save-status {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #4caf50;
      color: white;
      padding: 15px 25px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      display: none;
      animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(400px);
      }
      to {
        transform: translateX(0);
      }
    }
    
    .save-status.show {
      display: block;
    }
    
    .completed-message {
      background: #4caf50;
      color: white;
      padding: 20px;
      border-radius: 15px;
      text-align: center;
      margin-top: 30px;
      font-size: 18px;
      font-weight: 600;
    }
    
    .btn-finish-test {
      width: 100%;
      padding: 18px;
      background: linear-gradient(135deg, #f44336 0%, #e91e63 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      margin-top: 30px;
      transition: all 0.3s;
      box-shadow: 0 5px 15px rgba(244, 67, 54, 0.3);
    }
    
    .btn-finish-test:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(244, 67, 54, 0.4);
    }
    
    .btn-finish-test:disabled {
      background: #ccc;
      cursor: not-allowed;
      box-shadow: none;
    }
    
    .result-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .result-modal.show {
      display: flex;
    }
    
    .result-content {
      background: white;
      border-radius: 20px;
      padding: 40px;
      max-width: 500px;
      width: 90%;
      text-align: center;
      animation: modalSlideIn 0.3s ease;
    }
    
    @keyframes modalSlideIn {
      from {
        transform: translateY(-50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    .result-content h2 {
      color: #333;
      margin-bottom: 30px;
      font-size: 28px;
    }
    
    .result-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-box {
      padding: 20px;
      border-radius: 12px;
      background: #f5f5f5;
    }
    
    .stat-box.dogru {
      background: #e8f5e9;
      border: 2px solid #4caf50;
    }
    
    .stat-box.yanlis {
      background: #ffebee;
      border: 2px solid #f44336;
    }
    
    .stat-box.bos {
      background: #fff3e0;
      border: 2px solid #ff9800;
    }
    
    .stat-value {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 5px;
    }
    
    .stat-label {
      font-size: 14px;
      color: #666;
    }
    
    .result-puan {
      font-size: 48px;
      font-weight: 700;
      color: #667eea;
      margin: 20px 0;
    }
    
    .btn-close-modal {
      padding: 15px 40px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .btn-close-modal:hover {
      transform: scale(1.05);
    }
    
    .question-card.correct {
      border: 3px solid #4caf50;
      background: #f1f8f4;
    }
    
    .question-card.wrong {
      border: 3px solid #f44336;
      background: #fef5f5;
    }
    
    .question-card.empty {
      border: 3px solid #ff9800;
      background: #fff8f0;
    }
    
    .answer-indicator {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 10px;
    }
    
    .answer-indicator.correct {
      background: #4caf50;
      color: white;
    }
    
    .answer-indicator.wrong {
      background: #f44336;
      color: white;
    }
    
    .answer-indicator.empty {
      background: #ff9800;
      color: white;
    }

    .video-modal {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.9);
      animation: fadeIn 0.3s ease-in-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .video-modal-content {
      position: relative;
      margin: 2% auto;
      width: 90%;
      max-width: 1200px;
      height: 90%;
      background: #000;
      border-radius: 10px;
      overflow: hidden;
    }

    .video-modal-close {
      position: absolute;
      top: -40px;
      right: 0;
      color: #fff;
      font-size: 35px;
      font-weight: bold;
      cursor: pointer;
      z-index: 10001;
      background: rgba(244, 67, 54, 0.9);
      width: 45px;
      height: 45px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .video-modal-close:hover {
      background: rgba(244, 67, 54, 1);
      transform: scale(1.1);
    }

    .video-modal iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    .video-link-btn {
      display: inline-block;
      margin-top: 15px;
      padding: 10px 20px;
      background: linear-gradient(135deg, #f44336 0%, #e91e63 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 3px 10px rgba(244, 67, 54, 0.3);
    }

    .video-link-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(244, 67, 54, 0.4);
    }

    /* Responsive tasarƒ±m */
    @media (max-width: 768px) {
      .question-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }

      .question-title-wrapper {
        width: 100%;
        justify-content: space-between;
      }

      .question-actions {
        align-self: flex-end;
      }

      .student-answer-chip, .video-stats {
        font-size: 11px;
        padding: 5px 10px;
      }

      .answer-value, .video-count {
        font-size: 12px;
      }
    }

    @media (max-width: 480px) {
      .question-header {
        gap: 10px;
      }

      .question-title-wrapper {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }

      .student-answer-chip, .video-stats {
        font-size: 10px;
        padding: 4px 8px;
      }

      .answer-value, .video-count {
        font-size: 11px;
        padding: 1px 4px;
      }

      .question-title {
        font-size: 13px;
        padding: 8px 12px;
      }
    }
        gap: 8px;
      }

      .question-info {
        flex-wrap: wrap;
        gap: 5px;
      }

      .info-badge {
        font-size: 11px;
        padding: 4px 8px;
      }

      .question-title {
        font-size: 13px;
        padding: 6px 12px;
      }
    }

    @media (max-width: 480px) {
      .question-header {
        gap: 8px;
      }

      .question-number {
        gap: 6px;
      }

      .info-badge {
        font-size: 10px;
        padding: 3px 6px;
        gap: 3px;
      }

      .question-title {
        font-size: 12px;
        padding: 5px 10px;
      }

      .badge-label {
        font-size: 8px;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <div>
        <strong><%= ogrenci.ad %> <%= ogrenci.soyad %></strong>
      </div>
      <a href="/testler" class="btn-back">‚Üê Testlere D√∂n</a>
    </div>
  </div>
  
  <div class="container">
    <div class="test-header">
      <h2><%= testDurum.gorunen_test_adi %></h2>
      <p>Test Kodu: <strong><%= test.test_kodu %></strong> | <%= test.soru_sayisi %> Soru</p>
    </div>
    
    <% if (testDurum.durum === 'tamamlandi') { %>
      <div style="background: #e3f2fd; padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 5px solid #2196f3;">
        <strong>‚úì Bu testi tamamladƒ±nƒ±z!</strong><br>
        <small>A≈üaƒüƒ±da cevaplarƒ±nƒ±zƒ± ve √ß√∂z√ºm videolarƒ±nƒ± g√∂rebilirsiniz.</small>
      </div>
    <% } %>
    
    <% for(let i = 1; i <= test.soru_sayisi; i++) { %>
      <div class="question-card" id="soru_card_<%= i %>">
        <div class="question-header">
          <div class="question-title-wrapper">
            <span class="question-title">Soru <%= i %></span>
            <% if (cevaplar[i]) { %>
              <span class="student-answer-chip">
                <span class="answer-label">Cevabƒ±n:</span>
                <span class="answer-value"><%= cevaplar[i] %></span>
              </span>
            <% } %>
          </div>
          <div class="question-actions">
            <% if (test['video_' + i] && testDurum.durum === 'tamamlandi') { %>
              <div class="video-stats" title="Video ƒ∞zleme Sayƒ±sƒ±" id="video_views_<%= i %>">
                <span class="video-icon">üìπ</span>
                <span class="video-count views-count">0</span>
              </div>
            <% } %>
            <span class="answer-indicator" id="indicator_<%= i %>" style="display: none;"></span>
          </div>
        </div>
        <div class="options">
          <% ['A', 'B', 'C', 'D', 'E'].forEach(function(secenek) { %>
            <div class="option">
              <input 
                type="radio" 
                name="soru_<%= i %>" 
                id="soru_<%= i %>_<%= secenek %>"
                value="<%= secenek %>"
                data-soru-no="<%= i %>"
                data-test-id="<%= test.id %>"
                <%= cevaplar[i] === secenek ? 'checked' : '' %>
                <%= testDurum.durum === 'tamamlandi' ? 'disabled' : '' %>
              >
              <label for="soru_<%= i %>_<%= secenek %>"><%= secenek %></label>
            </div>
          <% }); %>
        </div>
        <% if (test['video_' + i] && testDurum.durum === 'tamamlandi') { %>
          <div style="margin-top: 15px;">
            <button class="video-link-btn" onclick="videoAc('<%= test['video_' + i] %>', <%= i %>)">
              üé• √á√∂z√ºm Videosunu ƒ∞zle
            </button>
          </div>
        <% } %>
      </div>
    <% } %>
    
    <% if (testDurum.durum !== 'tamamlandi') { %>
      <button id="btnFinishTest" class="btn-finish-test">
        üèÅ Testi Tamamla ve Deƒüerlendir
      </button>
      
      <div class="completed-message">
        ‚úÖ Cevaplarƒ±nƒ±z otomatik olarak kaydediliyor
      </div>
    <% } %>
  </div>
  
  <div class="save-status" id="saveStatus">
    üíæ Cevap kaydedildi!
  </div>
  
  <!-- Sonu√ß Modal -->
  <div class="result-modal" id="resultModal">
    <div class="result-content">
      <h2>üéâ Test Tamamlandƒ±!</h2>
      <div class="result-stats">
        <div class="stat-box dogru">
          <div class="stat-value" id="statDogru">0</div>
          <div class="stat-label">Doƒüru</div>
        </div>
        <div class="stat-box yanlis">
          <div class="stat-value" id="statYanlis">0</div>
          <div class="stat-label">Yanlƒ±≈ü</div>
        </div>
        <div class="stat-box bos">
          <div class="stat-value" id="statBos">0</div>
          <div class="stat-label">Bo≈ü</div>
        </div>
      </div>
      <div style="margin: 30px 0;">
        <div style="font-size: 18px; color: #666; margin-bottom: 10px;">Puanƒ±nƒ±z</div>
        <div class="result-puan" id="resultPuan">0</div>
      </div>
      <button class="btn-close-modal" onclick="window.location.reload()">
        √á√∂z√ºmleri G√∂r√ºnt√ºle
      </button>
    </div>
  </div>

  <!-- Video Modal -->
  <div id="videoModal" class="video-modal">
    <div class="video-modal-content">
      <span class="video-modal-close" onclick="videoKapat()">&times;</span>
      <iframe id="videoIframe" src="" allowfullscreen allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"></iframe>
    </div>
  </div>
  
  <script>
    const testDurum = '<%= testDurum.durum %>';
    const testId = '<%= test.id %>';
    
    // Video modal fonksiyonlarƒ±
    let currentVideoDetayId = null;
    let videoStartTime = null;

    // Sayfa y√ºklendiƒüinde video izleme sayƒ±larƒ±nƒ± getir
    document.addEventListener('DOMContentLoaded', function() {
      if (testDurum === 'tamamlandi') {
        loadVideoViewCounts();
      }
    });

    // Video izleme sayƒ±larƒ±nƒ± y√ºkle
    function loadVideoViewCounts() {
      fetch('/api/video-izleme-sayilari?test_id=' + testId)
        .then(response => response.json())
        .then(data => {
          if (data.success && data.sayilar) {
            data.sayilar.forEach(function(item) {
              const viewsElement = document.getElementById('video_views_' + item.soru_no);
              if (viewsElement) {
                const countElement = viewsElement.querySelector('.views-count');
                if (countElement) {
                  countElement.textContent = item.izleme_sayisi || 0;
                }
              }
            });
          }
        })
        .catch(error => {
          console.error('Video izleme sayƒ±larƒ± alƒ±namadƒ±:', error);
        });
    }

    // Tek bir sorunun video sayƒ±sƒ±nƒ± g√ºncelle
    function updateVideoViewCount(soruNo) {
      const viewsElement = document.getElementById('video_views_' + soruNo);
      if (viewsElement) {
        const countElement = viewsElement.querySelector('.views-count');
        if (countElement) {
          const currentCount = parseInt(countElement.textContent) || 0;
          countElement.textContent = currentCount + 1;
        }
      }
    }
    
    function videoAc(videoUrl, soruNo = null) {
      const modal = document.getElementById('videoModal');
      const iframe = document.getElementById('videoIframe');
      
      // Video izleme ba≈ülat - soru numarasƒ±nƒ± √ßƒ±kar
      if (!soruNo) {
        // Soru numarasƒ±nƒ± DOM'dan √ßƒ±karmaya √ßalƒ±≈ü
        const clickedButton = event.target;
        const questionDiv = clickedButton.closest('.question');
        if (questionDiv) {
          const questionText = questionDiv.querySelector('h3').textContent;
          const match = questionText.match(/Soru (\d+)/);
          if (match) {
            soruNo = parseInt(match[1]);
          }
        }
      }
      
      if (soruNo) {
        videoIzlemeBaslat(soruNo);
      }
      
      // YouTube URL'sini embed formatƒ±na √ßevir
      let embedUrl = videoUrl;
      if (videoUrl.includes('youtube.com/watch')) {
        const videoId = videoUrl.split('v=')[1]?.split('&')[0];
        if (videoId) {
          embedUrl = `https://www.youtube.com/embed/${videoId}`;
        }
      } else if (videoUrl.includes('youtu.be/')) {
        const videoId = videoUrl.split('youtu.be/')[1]?.split('?')[0];
        if (videoId) {
          embedUrl = `https://www.youtube.com/embed/${videoId}`;
        }
      }
      
      iframe.src = embedUrl;
      modal.style.display = 'block';
      document.body.style.overflow = 'hidden';
      
      // Video ba≈ülatma zamanƒ±nƒ± kaydet
      videoStartTime = Date.now();
    }

    function videoKapat() {
      const modal = document.getElementById('videoModal');
      const iframe = document.getElementById('videoIframe');
      
      // Video izleme bitir
      if (currentVideoDetayId && videoStartTime) {
        const izlemeSuresi = Math.floor((Date.now() - videoStartTime) / 1000);
        videoIzlemeBitir(currentVideoDetayId, izlemeSuresi);
      }
      
      modal.style.display = 'none';
      iframe.src = '';
      document.body.style.overflow = 'auto';
      
      // Reset video tracking
      currentVideoDetayId = null;
      videoStartTime = null;
    }
    
    // Video izleme tracking fonksiyonlarƒ±
    function videoIzlemeBaslat(soruNo) {
      videoStartTime = Date.now();
      
      fetch('/video-izleme-baslat', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          test_id: parseInt(testId),
          soru_no: soruNo
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          currentVideoDetayId = data.detay_id;
          console.log('Video izleme ba≈ülatƒ±ldƒ±:', data);
        } else {
          console.error('Video izleme ba≈ülatƒ±lamadƒ±:', data.message);
        }
      })
      .catch(error => {
        console.error('Video izleme ba≈ülatma hatasƒ±:', error);
      });
    }
    
    function videoIzlemeBitir(detayId, izlemeSuresi) {
      const videoYuzde = Math.min(100, (izlemeSuresi / 60) * 100); // Basit hesaplama
      const tamIzlendi = videoYuzde >= 80;
      
      fetch('/video-izleme-bitir', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          detay_id: detayId,
          izleme_suresi: izlemeSuresi,
          video_yuzde: videoYuzde,
          tam_izlendi: tamIzlendi,
          cikis_noktasi: izlemeSuresi
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          console.log('Video izleme tamamlandƒ±:', data);
          // Video sayƒ±larƒ±nƒ± g√ºncelle
          updateVideoViewCount(data.soru_no);
        } else {
          console.error('Video izleme g√ºncellenemedi:', data.message);
        }
      })
      .catch(error => {
        console.error('Video izleme bitirme hatasƒ±:', error);
      });
    }

    // Modal dƒ±≈üƒ±na tƒ±klanƒ±rsa kapat
    window.onclick = function(event) {
      const modal = document.getElementById('videoModal');
      if (event.target === modal) {
        videoKapat();
      }
    }

    // ESC tu≈üu ile kapat
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        videoKapat();
      }
    });
    
    // Test tamamlandƒ±ysa sonu√ßlarƒ± g√∂ster
    if (testDurum === 'tamamlandi') {
      // Test sonucunu al ve g√∂ster
      fetch('/test-sonuc?test_id=' + testId)
        .then(response => response.json())
        .then(data => {
          if (data.success && data.sonuc) {
            gosterSonuclari(data.sonuc);
          }
        });
    }
    
    // Her se√ßenek deƒüi≈ütiƒüinde AJAX ile kaydet
    document.querySelectorAll('input[type="radio"]').forEach(function(radio) {
      radio.addEventListener('change', function() {
        const soruNo = this.dataset.soruNo;
        const testId = this.dataset.testId;
        const cevap = this.value;
        
        fetch('/cevap-kaydet', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            test_id: testId,
            soru_no: soruNo,
            cevap: cevap
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Kayƒ±t ba≈üarƒ±lƒ± mesajƒ± g√∂ster
            const status = document.getElementById('saveStatus');
            status.classList.add('show');
            setTimeout(() => {
              status.classList.remove('show');
            }, 2000);
          }
        })
        .catch(error => {
          console.error('Kayƒ±t hatasƒ±:', error);
        });
      });
    });
    
    // Test tamamlama butonu
    const btnFinishTest = document.getElementById('btnFinishTest');
    if (btnFinishTest) {
      btnFinishTest.addEventListener('click', function() {
        if (!confirm('Testi tamamlamak istediƒüinize emin misiniz? Bu i≈ülem geri alƒ±namaz!')) {
          return;
        }
        
        btnFinishTest.disabled = true;
        btnFinishTest.textContent = 'Deƒüerlendiriliyor...';
        
        fetch('/test-tamamla', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            test_id: testId
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Sonu√ßlarƒ± g√∂ster
            document.getElementById('statDogru').textContent = data.sonuc.dogru;
            document.getElementById('statYanlis').textContent = data.sonuc.yanlis;
            document.getElementById('statBos').textContent = data.sonuc.bos;
            document.getElementById('resultPuan').textContent = data.sonuc.puan;
            
            // Modal'ƒ± g√∂ster
            document.getElementById('resultModal').classList.add('show');
          } else {
            alert('Test tamamlanamadƒ±: ' + data.message);
            btnFinishTest.disabled = false;
            btnFinishTest.textContent = 'üèÅ Testi Tamamla ve Deƒüerlendir';
          }
        })
        .catch(error => {
          console.error('Hata:', error);
          alert('Bir hata olu≈ütu!');
          btnFinishTest.disabled = false;
          btnFinishTest.textContent = 'üèÅ Testi Tamamla ve Deƒüerlendir';
        });
      });
    }
    
    // Sonu√ßlarƒ± g√∂ster (test tamamlandƒ±ysa)
    function gosterSonuclari(sonuc) {
      sonuc.detaylar.forEach(detay => {
        const card = document.getElementById('soru_card_' + detay.soru_no);
        const indicator = document.getElementById('indicator_' + detay.soru_no);
        
        if (card && indicator) {
          if (detay.durum === 'dogru') {
            card.classList.add('correct');
            indicator.classList.add('correct');
            indicator.textContent = '‚úì Doƒüru';
            indicator.style.display = 'inline-block';
          } else if (detay.durum === 'yanlis') {
            card.classList.add('wrong');
            indicator.classList.add('wrong');
            indicator.textContent = '‚úó Yanlƒ±≈ü (Doƒüru: ' + detay.dogru_cevap + ')';
            indicator.style.display = 'inline-block';
          } else {
            card.classList.add('empty');
            indicator.classList.add('empty');
            indicator.textContent = '- Bo≈ü (Doƒüru: ' + detay.dogru_cevap + ')';
            indicator.style.display = 'inline-block';
          }
        }
      });
    }
  </script>
</body>
</html>
